<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>首頁</title>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="{{url_for('static',filename='style.css')}}">
    
</head>
<body>
  <h1>全球太陽紫外線指數(UVI)-台灣監測站資料</h1>
  <h3>最新更新時間: {{ nowtime }}</h3>
  <a class="btn-update" href="/update_db">更新資料庫</a>
    
    
  <form action="/" method="GET">
        <label for="county">選取縣市</label>
        <!-- 縣市選擇框 -->
        <select name="county" id="county" >
            <option value="ALL">全部縣市</option>
            {% for county in counties %}
            <option value="{{county}}" {% if selected_county == county %} selected {% endif %}>{{county}}</option>
            {% endfor %}
        </select>
        <button type="submit">查詢</button> 
  </form>
    
  <h2 >目前縣市:{{selected_county}}</h2>

  <button id="toggleButton">切換圖表</button>
  <div id="map"></div>
  
  <script>
    const uviData = {{ uvi_data | tojson | safe }};
    const selectedCounty = "{{ selected_county }}";
    const isAllCounty = (selectedCounty === "ALL");
    // ✅ 初始化圖表要在最外層，確保 myChart 有定義
    const myChart = echarts.init(document.getElementById("map"));
    myChart.showLoading();

    // ✅ 使用正確的 GeoJSON 來源
    $.get('/static/twCounty2010.geo.json', function (geoJson) {
      myChart.hideLoading();

      if (!geoJson || !geoJson.features) {
        alert("❌ 載入地圖失敗：geoJson.features 為 undefined");
        return;
      }

      // ✅ 給每個區塊加上 name（ECharts 根據 name 找資料）
      geoJson.features.forEach(f => {
        f.properties.name = f.properties.COUNTYNAME;
      });

      echarts.registerMap('Taiwan', geoJson);

      const sortedUviData = [...uviData].sort((a, b) => b.value - a.value);
      // const isSingleData = (sortedUviData.length <= 1);        
    
      // 地圖版
      const mapOption = {
        tooltip: {
          trigger: 'item',
          formatter: '{b}<br/>UVI: {c}'
        },
        visualMap: {
          min: 0,
          max: 11,
          left: 'left',
          top: 'bottom',
          text: ['高', '低'],
          calculable: true,
          inRange: {
            color: ['#00ff00', '#ffff00', '#ffa500', '#ff0000', '#8b00ff']
          }
        },
        
        animationDurationUpdate: 1000,
        animationEasingUpdate: 'cubicInOut',
      
        series: [{
          id: 'uvi',
          type: 'map',
          map: 'Taiwan',
          roam: true,
          label: { show: true },
          data: uviData,
          universalTransition: true
        }]
      };

      // 柱狀圖版
      const barOption = {
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'value',name: 'UVI' },
        yAxis: {
          type: 'category',
          data: sortedUviData.map(item => item.name),
          axisLabel: { interval: 0, rotate: 15 }
        },
        
        animationDurationUpdate: 1000,
        animationEasingUpdate: 'cubicInOut',
        
        series: [{
          id: 'uvi',
          type: 'bar',
          data: sortedUviData.map(item => item.value),
          universalTransition: true
        }]
      };

      myChart.setOption(mapOption);


      let currentOption = 'map';
      const button = document.getElementById('toggleButton');
      // ✅ 只有「全部縣市」時才啟動動畫切換
      if (!isAllCounty) {button.style.display = 'none';}
      
      button.addEventListener('click', () => {
        if (currentOption === 'map') {
          myChart.setOption(barOption, true);
          currentOption = 'bar';
        } else {
          myChart.setOption(mapOption, true);
          currentOption = 'map';
        }
      });
    });
  </script>

  <table border="1">
      <thead>
          <tr>
              {% for col in columns %}
              <th>{{col}}</th>
              {% endfor %}
          </tr>
      </thead>
      <tbody>
          {% for row in datas %}
          <tr>
              {% for data in row %}
              <td>{{data}}</td>
              {% endfor %}
          </tr>
          {% endfor %}
      </tbody>
  </table>
    
</body>
</html>